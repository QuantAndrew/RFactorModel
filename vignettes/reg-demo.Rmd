---
title: "Multiple factors model using regression"
author: "UBSSDIC Quant Group"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Regression Method Demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette aims to help you work with the regression method in multiple factors model. We will seperate the help file in following part:

- local regression tables
- regression result show
- portfolio optimization
- traditional portfolio construction

```{r setup,echo=FALSE,include=FALSE}
library(RFactorModel)
library(knitr)
knitr::opts_chunk$set(
  eval = FALSE,
  warning = FALSE
)
```


## local regression tables

Local database's factorlist table is as below.
```{r local_factorLists,eval=TRUE,echo=FALSE}
ftbale <- CT_FactorLists()
ftbale <- dplyr::arrange(ftbale,factorID)
kable(ftbale)
```


Get recommended factor lists by regression.
```{r getfactorlist}
# get recommended factorlists last year based on regression
begT <- trday.nearest(Sys.Date()-months(6))
endT <- trday.nearest(Sys.Date()-1)
indexID <- 'EI000985'
re <- reg.factorlists_recommend(indexID,begT,endT,forder = c('ln_mkt_cap_','PB_mrq_','pct_chg_per_60_','liquidity_'))
FactorLists <- re$FactorLists
# recommend result
kable(re$result)
```


Show factors' correlation and statistic result.
```{r showfactorstat}
begT <- trday.nearest(Sys.Date()-lubridate::years(6))
endT <- trday.nearest(Sys.Date()-1)
RebDates <- getRebDates(begT,endT)
TS <- getTS(RebDates,indexID)

# remove high correlated or large proportion of missing factors
dropf <- c('F_ROE_1','float_cap_','disposition_')
FactorLists <- FactorLists[sapply(FactorLists,function(x) !(x$factorName %in% dropf))]

TSF <- na.omit(getMultiFactor(TS,FactorLists))

MF.chart.Fct_box(TSF)
MF.chart.Fct_corr(TSF)
MF.chart.Fct_density(TSF)


#dealing with factor correlation
TSF <- factor_orthogon_single(TSF,y='ILLIQ',x = 'ln_mkt_cap_',sectorAttr = NULL)
TSF <- factor_orthogon_single(TSF,y='volatility_',x = 'liquidity_',sectorAttr = NULL)
TSFR <- na.omit(getTSR(TSF))

```



Build and update local database's regression result tables.
```{r getlists_buildlocaltables}
# build local database's regression tables
system.time(lcdb.build.RegTables(FactorLists=FactorLists))

# update local database's regression tables
system.time(lcdb.update.RegTables(FactorLists = FactorLists))
```


## regression result show

```{r reg_result}
# get regression result
reg_results <- reg.TSFR(TSFR)

## show regression result
# regression's rsquare plot
chart.reg.rsquare(reg_results)
# regression's rsquare table
table.reg.rsquare(reg_results)
# correlation plot of factor's return 
MC.chart.regCorr(reg_results)
# pure factor's wealth index
chart.reg.fRtnWealthIndex(reg_results,facet = T)
# barplot of pure factor's return 
chart.reg.fRtnBar(reg_results)
# summarise table of pure factor's return 
table.reg.fRtn(reg_results)
```


## portfolio optimization

```{r portOpt}
# set alpha factor
alphaf <- c('liquidity_','ROE_ttm',"PB_mrq_",'NP_YOY','F_NP_chg_w13')

# get factor return
fRtn <- getfRtn(fname = alphaf,rtntype = 'mean',reg_results = reg_results)
# get factor covariance
fCov <- getfCov(fname = alphaf,covtype='shrink',reg_results = reg_results)

# # Date Alignment
# tmp.date1 <- max(min(fRtn$date),min(fCov$date))
# tmp.date2 <- min(max(fRtn$date),max(fCov$date))
# fRtn <- subset(fRtn,date>=tmp.date1,date<=tmp.date2)
# fCov <- subset(fCov,date>=tmp.date1,date<=tmp.date2)
# TSF <- subset(TSF,date>=tmp.date1,date<=tmp.date2)

## portfolio demo
# set factor's exposure
fexp <- buildFactorExp(sectorall = c(0,0.1),
                        liquidity_ = c(-0.01, 100),
                        ln_mkt_cap_=c(-0.01, 0.01),
                        PB_mrq_=c(-0.01,100),
                        ROE_ttm=c(-0.01,100),
                        volatility_=c(-0.01,0.01),
                        pct_chg_per_60_=c(-0.01,0.01),
                        NP_YOY=c(-0.01,100),
                        F_NP_chg_w13=c(-0.01,100))


#get newest optimized portfolio
TS <- getTS(endT,indexID)
TS <- rm_suspend(TS)
TS <- is_st(TS)
TS <- TS[!(TS$is_st),c('date','stockID')]
TSF <- getMultiFactor(TS,FactorLists)

# simplest way:no benchmark,maximize return
system.time(port_opt <- OptWgt(TSF,alphaf,fRtn,target = 'return',factorExp = fexp))

system.time(port_opt <- OptWgt(TSF,alphaf,fRtn,fCov,target = 'balance',factorExp = fexp,optWay = 'solve.QP'))


#build weight setting
wgtSet <- buildWgtSet(ES33480000=c(0,0.05),ES33490000=c(0,0.03))

#build box constrain
boxConstr <- buildBoxConstr(EI000906=c(0.7,0.8))
# with benchmark,maximize return, box constrain
system.time(port_opt <- OptWgt(TSF,alphaf,fRtn,target = 'return',bmk = 'EI000906',factorExp = fexp,wgtSet = wgtSet))

# with benchmark,risk return balance
system.time(port_opt <- OptWgt(TSF,alphaf,fRtn,fCov,target = 'balance',bmk = 'EI000906',factorExp = fexp,boxConstr = boxConstr))



# port backtest and return summary
portrtn <- port.backtest(port_opt,fee.buy = 0.001)
benchrtn <- getrtn.bmk(portrtn, bmk = "EI000905")
allrtn <- addrtn.hedge(portrtn,benchrtn)
ggplot.WealthIndex(allrtn)
rtn.summary(allrtn)
rtn.periods(allrtn)
```


## traditional portfolio construction


```{r ICmethods}
#set modelPar
modelPar <- modelPar.default()
modelPar <- setmodelPar.time(modelPar,begT,endT)
modelPar <- setmodelPar.univ(modelPar,'EI000905')

#get factor wgt
factorIDs <- c("F000006","F000008","F000013","F000017")
tmp <- buildFactorLists_lcfs(factorIDs,factorStd="norm",factorNA = "mean")
FactorLists <- buildFactorLists(
  buildFactorList(factorFun="gf.NP_YOY",
                  factorPar=list(),
                  factorDir=1),
    buildFactorList(factorFun="gf.ln_mkt_cap",
                  factorPar=list(),
                  factorDir=1),
  factorStd="norm",factorNA = "median")
FactorLists <- c(tmp,FactorLists)
MPs <- getMPs_FactorLists(FactorLists, modelPar)
TSFRs <- Model.TSFRs(MPs)
wgt <- MC.wgt.CAPM(TSFRs,wgtmin = 0.05,wgtmax = 0.3)

#get port and backtest
TS <- Model.TS(modelPar)
TSF2 <- getMultiFactor(TS,FactorLists = FactorLists,wgts = wgt)
port2 <- getPort(TSF2,topN = 100,pick.sectorNe = T)
port2 <- port2[,c('date','stockID')]
port2 <- addwgt2port(port2, wgt.sectorNe = T, wgtbmk = "EI000905")
re2 <- port.backtest(port2,fee.buy = 0.001)
benchrtn2 <- getrtn.bmk(re2, bmk = "EI000905")
allrtn2 <- addrtn.hedge(re2,benchrtn2)
ggplot.WealthIndex(allrtn2)
rtn.summary(allrtn2)
rtn.periods(allrtn2)
```



